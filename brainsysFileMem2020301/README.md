Self-testing launch
========================
1.  Launch /brainsysFileMem2020301/Brainw.exe (Windows only)
2.  Ввод
    -  Установки для ввода ЭЭГ...
    -  Choose frequency, Hz (Частота оцифровки, ГЦ)
    -  Отображение в памяти - Передача серверу биосгнала в мкВ
    -  ОК
3.  Ввод
    -  Тестирование
    -  Sinus Simulation

АПК "Нейро-сенсор НейроКМ"
========================
АПК представляет из себя классический многоканальный электроэнцефалограф для регистрации и компьютерного анализа фоновой биоэлектрической активности головного мозга методом топографического картирования, зрительных и когнитивных (методика Р300) вызванных потенциалов, а также для трёхмерной локализации очагов физиологической и патологической БЭА [[Научно-медицинская фирма СТАТОКИН](https://www.statokyn.ru/ "Главная страница")], программная часть для ОС MS Windows которого – система топографического картирования БЭА головного мозга и анализа зрительных и когнитивных (методика Р300) вызванных потенциалов «BrainSys» – была разработана директором Научно-производственной фирмы «Нейрометрикс», инженером-программистом Митрофановым А.А.

В основе проведения методики Р300 лежит подача серии различных стимулов (звуковые, зрительные), среди которых подаются значимые и не значимые стимулы. На значимые стимулы испытуемый должен реагировать. Значимый стимул отличается от не значимого определенными характеристиками, он подается среди большего количества не значимых в случайном порядке, его нужно опознать и подсчитать количество [[Национальный медицинский исследовательский центр имени академика Е.Н. Мешалкина](https://meshalkin.ru/issledovaniye-vyzvannykh-potentsialov "Исследование вызванных потенциалов")].

![Фотография аппаратной части и интерфейса программной части АПК](http://www.ordas.ru/sites/default/files/styles/300x300/public/pictures/catalog/neuro-km.jpg)

В состав программной части АПК, помимо модулей регистрации вызванных потенциалов и других, входит модуль взаимодействия с программным интерфейсом File Mapping: в отображенный файл в реальном времени последовательно записываются зарегистрированные АЦП биопотенциалы. Другое ПО через этот интерфейс также может получить доступ к считанным с АЦП данным.

Программный интерфейс АПК «Нейро-КМ»
------------------------
Программный интерфейс АПК позволяет получить доступ к измеренным АЦП значениям биопотенциалов в мкВ с 22-х возможных каналов непосредственно в памяти программы при помощи протокола File Mapping.

File Mapping позволяет отображать файлы на участок памяти программы, таким образом при попытке чтения из памяти производится попытка чтения соответствующих байт из отображенного файла.

Для открытия отображенного в память файла необходимо иметь два значения: 1) название файла, для программного интерфейса АПК – “NeuroKMData” как ANSI-строка, 2) размер файла в байтах.

Чтобы получить размер отображаемого в память файла, необходимо провести простые математические вычисления:

размеры в байтах AnsiChar (Char), single (Float), integer, tDateTime (Double), int64 равны 1, 4, 4, 8, 8 Байт соответственно.

Из вышеизложенного размер файла равен:

Х = 8 × 5 + 4 × 22 × 2 + 1 × 512 + (8 + 8 + 4 × 22) × 10000 = 1040728 Байт

```delphi
const nkMaxData = 10000; //Размер буфера записанных
                     // данных, не отображается
Type tnkData=
record
nkdVersion  : int64; // Версия программы
nkdReady    : int64; // Просто некое число
nkdCut      : int64; // Текущее сечение – счетчик
                     // записанных значений
nkdFrequency: int64; // Частота оцифровки
nkdChannels : int64; // Текущее количество каналов
nkdLeadsAct : array[1..22] of integer; 
nkdLeadsPas : array[1..22] of integer;
nkdName     : array[1..512] of AnsiChar;
nkdDATA_MV  : array[0..nkMaxData] of
  record
    
    nkdAstrTime: tDateTime;// Момент регистрации
                       // сигнала
    nkdCutCnt  : int64;// Сечение (значения счетчика)
                       // для текущего значения данных
    nkdData    : array[1..22] of single;// Данные по
                       // каналам в мкВ
  end;
end;

Var hMapOnLine   : THandle;
    lpBaseAddress: Pointer;
    nkData       :^tnkData absolute lpBaseAddress;
```

Дальнейшие действия должны следовать рекомендациям в документации на библиотеку Memory Mapped Files для конкретной среды разработки.

Процесс произведения записи данных в отображенную память
------------------------
Ключевое слово absolute позволяет указать компилятору рассматривать одну или несколько переменных как существующие в одном месте в памяти.

Так объект типа nkData будет указателем на объект типа tnkData по адресу указателя lpBaseAddress, который используется далее для отображения файла в памяти. Можно сказать, что объект tnkData трактуется компилятором как один из видов переменной lpBaseAddress.

Подобная конструкция позволяет опустить вызовы операций записи в отображенный файл, поскольку при записи в переменную из tnkData по указателю nkData будет происходить запись по адресу в памяти, с которым ассоциирован отображенный файл.

```delphi
hMapOnLine:=CreateFileMapping(MAXDWORD,Nil,
                              PAGE_READWRITE,0,
                              SizeOf(tnkData),
                              ‘NeuroKMData’);
lpBaseAddress:=MapViewOfFile(hMapOnLine,
                             FILE_MAP_READ Or
                             FILE_MAP_WRITE,0,
                             0,SizeOf(tnkData));
cnt:=0;
with nkData^ do
  begin
    repeat
      nkdDataMV[cnt mod nkMaxData].nkdAstrTime:=Now;
      for k:=1 to nc do
        begin
          nkdDataMV[cnt mod nkMaxData].nkdData[k]:=
                                       CurMVData(k);
        end;
      nkdDataMV[cnt mod nkMaxData].nkdCutCnt:=cnt;
      nkdCut:=cnt;
      inc(cnt);
      application.ProcessMessages;
      until stop;
  end;
```

Для создания объекта File Mapping была вызвана функция CreateFileMapping с указанными ранее именем файла и его размером (“NeuroKMData” и 1040728 Байт, которое возвращено при вызове функции SizeOf, соответственно). Созданный объект отображается на адрес lpBaseAddress при вызове функции MapViewOfFile, по которому ранее с помощью absolute было указано существование tnkData.

Присвоение считанных с АЦП биопотенциалов происходит через разыменование указателя nkData и получение значения типа tnkData.

Отдельно следует обратить внимание на использованное ключевое слово mod, которое в данном случае возвращает остаток деления значения переменной cnt и значения переменной nkMaxData, что позволяет циклически перезаписывать значения в отображаемом файле без обнуления счетчика сечений nkdCut, постоянно увеличивающееся значение которого критично для разработанного ПО.
